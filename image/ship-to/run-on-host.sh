#!/usr/bin/env bash
# Inspired by https://medium.com/@patnaikshekhar/initialize-your-aks-nodes-with-daemonsets-679fa81fd20e

# Copy installation scripts and files to host
cp /ship-to/* /host
cp /tmp/install.sh /host  

# Wait for updates to complete
/usr/bin/nsenter -m/proc/1/ns/mnt -- chmod u+x /tmp/install/wait.sh

# Give execute priv to script
/usr/bin/nsenter -m/proc/1/ns/mnt -- chmod u+x /tmp/install/install.sh

/usr/bin/nsenter -m/proc/1/ns/mnt -- cp /tmp/install/wait.sh /var/log/
/usr/bin/nsenter -m/proc/1/ns/mnt -- cp /tmp/install/install.sh /var/log/

# Wait for Node updates to complete
/usr/bin/nsenter -m/proc/1/ns/mnt /var/log/wait.sh

# If the /tmp folder is mounted on the host then it can run the script
/usr/bin/nsenter -m/proc/1/ns/mnt /var/log/install.sh

# Sleep 30 seconds, then exit
echo "Waiting for 30 seconds..."
sleep 30
echo "Task Completed"
